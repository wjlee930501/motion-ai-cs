"""
LLM 프롬프트 템플릿

핵심 원칙:
- 구조화 강제 (X) → 열린 질문 (O)
- 특정 포맷 요구 (X) → 자유로운 정리 (O)
"""

SYSTEM_PROMPT = """당신은 모션랩스 CS 분석가입니다.

모션랩스는 병원에 마케팅 솔루션을 제공하는 회사이며,
약 400개 병원 고객과 카카오톡으로 CS 소통을 합니다.

당신의 역할:
- 축적된 CS 대화 로그를 읽고 이해를 형성하는 것
- 모션랩스 직원들의 응대 방식을 파악하는 것
- 고객들의 요청 양상을 이해하는 것
- 대화의 상호작용 패턴을 발견하는 것

주의사항:
- 데이터가 적을 수 있습니다. 무리하게 패턴을 만들지 마세요.
- 확실한 것과 추측을 구분해서 말해주세요.
- 이전 이해가 있다면, 그것을 발전시키는 방향으로 작성하세요."""


def build_user_prompt(
    previous_understanding: str | None,
    logs_text: str,
    log_count: int,
    date_from,
    date_to
) -> str:
    """사용자 프롬프트 구성"""

    prev_section = previous_understanding or "없음 (첫 번째 학습입니다)"

    if date_from and date_to:
        date_range = f"{date_from.strftime('%Y-%m-%d')} ~ {date_to.strftime('%Y-%m-%d')}"
    else:
        date_range = "날짜 정보 없음"

    return f"""## 이전 이해

{prev_section}

---

## 대화 로그

총 {log_count}건의 대화 ({date_range})

{logs_text}

---

## 요청

위 대화 로그를 바탕으로 당신의 이해를 정리해주세요.

다음 관점에서 자유롭게 분석해주세요:

1. **모션랩스 CS 응대 방식**
   - 직원들은 어떤 톤과 방식으로 대화하는가?
   - 어떤 응대 패턴이 보이는가?

2. **고객 요청 양상**
   - 고객들은 주로 무엇을 물어보는가?
   - 어떤 표현과 키워드를 사용하는가?

3. **상호작용 다이나믹스**
   - 대화가 어떻게 흘러가는가?
   - 어떤 응대가 효과적으로 보이는가?

4. **메시지 분류 패턴 (중요)**
   이 섹션은 자동 분류 시스템에서 활용됩니다.

   **답변 필요 메시지 패턴:**
   - 어떤 표현/키워드가 나오면 답변이 필요한가?
   - 예: "~해주세요", "~가능한가요?", "문의드립니다" 등

   **답변 불필요 메시지 패턴:**
   - 어떤 표현이 단순 확인/감사/인사인가?
   - 예: "감사합니다", "알겠습니다", "확인했어요" 등

   **자료전송 메시지 패턴:**
   - 고객이 자료만 보내는 경우 어떤 표현을 쓰는가?
   - 예: "사진 보내드립니다", 이미지 첨부만 있는 경우

   **판단이 애매한 케이스:**
   - 답변 필요 여부 판단이 어려운 메시지 유형은?
   - 어떤 기준으로 판단하면 좋을까?

5. **추가 발견**
   - 그 외 눈에 띄는 것들

6. **이전 이해 대비 변화** (이전 이해가 있는 경우)
   - 새롭게 알게 된 것
   - 수정이 필요한 것
   - 더 확신하게 된 것

데이터가 부족하면 부족하다고 솔직하게 말해주세요.
무리하게 패턴을 만들 필요 없습니다."""
